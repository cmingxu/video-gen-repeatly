# è§†é¢‘ç”Ÿæˆå™¨ - Pythonç‰ˆæœ¬

è¿™æ˜¯ä¸€ä¸ªå°†åŸå§‹bashè„šæœ¬é‡å†™ä¸ºPythonçš„è§†é¢‘ç”Ÿæˆå·¥å…·ï¼Œæ”¯æŒå†…ç½®å®šæ—¶è°ƒåº¦ï¼Œæ— éœ€Dockerã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ **Pythoné‡å†™**: å°†åŸå§‹bashè„šæœ¬è½¬æ¢ä¸ºæ›´æ˜“ç»´æŠ¤çš„Pythonä»£ç 
- â° **å†…ç½®è°ƒåº¦**: ä½¿ç”¨Python scheduleåº“å®ç°å®šæ—¶è°ƒåº¦ï¼Œæ— éœ€å¤–éƒ¨ä¾èµ–
- ğŸ“Š **å¤šç±»åˆ«æ”¯æŒ**: æ”¯æŒè”¬èœã€æ°´æœã€æ°´äº§ã€è‚‰ç¦½è›‹å››ä¸ªç±»åˆ«
- ğŸ“ **æ—¥å¿—è®°å½•**: å®Œæ•´çš„æ‰§è¡Œæ—¥å¿—å’Œé”™è¯¯è¿½è¸ª
- ğŸ”„ **æ–‡ä»¶åŒæ­¥**: è‡ªåŠ¨åŒæ­¥ç”Ÿæˆçš„æ–‡ä»¶åˆ°è¿œç¨‹æœåŠ¡å™¨
- ğŸš€ **ç®€å•éƒ¨ç½²**: çº¯Pythonå®ç°ï¼Œæ— éœ€Docker

## é¡¹ç›®ç»“æ„

```
video-gen-repeatly/
â”œâ”€â”€ video_generator.py      # ä¸»è¦çš„Pythonè„šæœ¬
â”œâ”€â”€ setup.py               # å¿«é€Ÿè®¾ç½®è„šæœ¬
â”œâ”€â”€ Dockerfile             # Dockeré•œåƒæ„å»ºæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ docker-compose.yml     # Docker Composeé…ç½®ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ requirements.txt       # Pythonä¾èµ–åŒ…
â”œâ”€â”€ README.md             # é¡¹ç›®è¯´æ˜æ–‡æ¡£
â”œâ”€â”€ .env                  # ç¯å¢ƒå˜é‡é…ç½®æ–‡ä»¶
â”œâ”€â”€ .env.example          # ç¯å¢ƒå˜é‡é…ç½®æ¨¡æ¿
â”œâ”€â”€ logs/                 # æ—¥å¿—æ–‡ä»¶ç›®å½•
â””â”€â”€ data/                 # æ•°æ®æ–‡ä»¶ç›®å½•
```

## å¿«é€Ÿå¼€å§‹

### 1. è‡ªåŠ¨è®¾ç½®ï¼ˆæ¨èï¼‰

```bash
# è¿è¡Œè®¾ç½®è„šæœ¬
python setup.py
```

è¿™å°†è‡ªåŠ¨ï¼š
- åˆ›å»ºå¿…è¦çš„ç›®å½•
- å®‰è£…Pythonä¾èµ–
- åˆ›å»ºé…ç½®æ–‡ä»¶

### 2. æ‰‹åŠ¨è®¾ç½®

#### å®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

#### åˆ›å»ºå¿…è¦çš„ç›®å½•
```bash
mkdir -p logs data/output
```

#### é…ç½®ç¯å¢ƒå˜é‡
å¤åˆ¶å¹¶ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼š
```bash
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œé…ç½®ä½ çš„APIåœ°å€å’ŒæœåŠ¡å™¨ä¿¡æ¯
```

### 3. é…ç½®SSHå¯†é’¥

ç¡®ä¿ä½ çš„SSHå¯†é’¥å·²æ­£ç¡®é…ç½®ï¼š
```bash
# æ£€æŸ¥SSHå¯†é’¥
ls -la ~/.ssh/id_rsa

# å¦‚æœéœ€è¦ï¼Œç”Ÿæˆæ–°çš„SSHå¯†é’¥
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
```

## ä½¿ç”¨æ–¹æ³•

### æŸ¥çœ‹å¸®åŠ©

```bash
python video_generator.py --help
```

### æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡

```bash
# ç«‹å³æ‰§è¡Œä¸€æ¬¡è§†é¢‘ç”Ÿæˆä»»åŠ¡
python video_generator.py --run-once
```

### å¯åŠ¨å®šæ—¶è°ƒåº¦

```bash
# å¯åŠ¨è°ƒåº¦å™¨ï¼Œæ¯æ—¥ä¸‹åˆ2ç‚¹è‡ªåŠ¨æ‰§è¡Œ
python video_generator.py

# ç¨‹åºå°†æŒç»­è¿è¡Œï¼ŒæŒ‰ Ctrl+C åœæ­¢
```

### åå°è¿è¡Œ

```bash
# ä½¿ç”¨ nohup åœ¨åå°è¿è¡Œ
nohup python video_generator.py > scheduler.log 2>&1 &

# æŸ¥çœ‹è¿›ç¨‹
ps aux | grep video_generator

# åœæ­¢åå°è¿›ç¨‹
kill <process_id>
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f logs/video_generator.log

# æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—
tail -n 50 logs/video_generator.log
```

## Dockerä½¿ç”¨æ–¹æ³•ï¼ˆå¯é€‰ï¼‰

å¦‚æœä½ æ›´å–œæ¬¢ä½¿ç”¨Dockerï¼Œé¡¹ç›®ä¹Ÿæä¾›äº†Dockeræ”¯æŒï¼š

### æ„å»ºé•œåƒ

```bash
docker-compose build
```

### å¯åŠ¨è°ƒåº¦å™¨

```bash
# å¯åŠ¨è°ƒåº¦å™¨æœåŠ¡ï¼ˆåå°è¿è¡Œï¼‰
docker-compose up -d video-generator

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f video-generator
```

### æ‰‹åŠ¨æ‰§è¡Œä¸€æ¬¡

```bash
# ç«‹å³æ‰§è¡Œä¸€æ¬¡
docker-compose run --rm video-generator-once
```

### åœæ­¢æœåŠ¡

```bash
docker-compose down
```

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|--------|------|
| `API_URL` | `http://localhost:3100/api/generate-video` | è§†é¢‘ç”ŸæˆAPIåœ°å€ |
| `RSYNC_SOURCE` | `./data/output` | rsyncæºç›®å½• |
| `RSYNC_DEST` | `root@112.126.78.105:~/web/x` | rsyncç›®æ ‡åœ°å€ |
| `SSH_KEY_PATH` | `~/.ssh/id_rsa` | SSHç§é’¥è·¯å¾„ |
| `SCHEDULE_TIME` | `14:00` | æ¯æ—¥æ‰§è¡Œæ—¶é—´ (24å°æ—¶åˆ¶) |

### å•†å“ç±»åˆ«

è„šæœ¬ä¼šä¸ºä»¥ä¸‹4ä¸ªç±»åˆ«ç”Ÿæˆè§†é¢‘ï¼š
- è”¬èœ
- æ°´æœ
- æ°´äº§
- è‚‰ç¦½è›‹

### æ—¥å¿—æ–‡ä»¶

æ—¥å¿—æ–‡ä»¶ä¿å­˜åœ¨ `logs/video_generator.log`ï¼ŒåŒ…å«ï¼š
- æ‰§è¡Œæ—¶é—´æˆ³
- è°ƒåº¦å™¨çŠ¶æ€
- æ¯ä¸ªç±»åˆ«çš„å¤„ç†çŠ¶æ€
- HTTPè¯·æ±‚è¯¦æƒ…
- æ–‡ä»¶åŒæ­¥ç»“æœ
- é”™è¯¯ä¿¡æ¯

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **SSHè¿æ¥å¤±è´¥**
   - æ£€æŸ¥SSHå¯†é’¥æƒé™ï¼š`chmod 600 ~/.ssh/id_rsa`
   - ç¡®è®¤ç›®æ ‡æœåŠ¡å™¨å¯è®¿é—®
   - æ£€æŸ¥SSHå¯†é’¥æ˜¯å¦æ­£ç¡®
   - æµ‹è¯•SSHè¿æ¥ï¼š`ssh -i ~/.ssh/id_rsa root@112.126.78.105`

2. **APIè¯·æ±‚å¤±è´¥**
   - æ£€æŸ¥APIæœåŠ¡æ˜¯å¦è¿è¡Œ
   - ç¡®è®¤API_URLé…ç½®æ­£ç¡®
   - æŸ¥çœ‹ç½‘ç»œè¿æ¥çŠ¶æ€
   - æµ‹è¯•APIï¼š`curl -X POST http://localhost:3100/api/generate-video`

3. **å®šæ—¶ä»»åŠ¡ä¸æ‰§è¡Œ**
   - æ£€æŸ¥ç¨‹åºæ˜¯å¦åœ¨è¿è¡Œï¼š`ps aux | grep video_generator`
   - æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼š`tail -f logs/video_generator.log`
   - ç¡®è®¤SCHEDULE_TIMEæ ¼å¼æ­£ç¡® (HH:MM)

4. **ä¾èµ–å®‰è£…å¤±è´¥**
   - å‡çº§pipï¼š`pip install --upgrade pip`
   - ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒï¼š`python -m venv venv && source venv/bin/activate`

### è°ƒè¯•æ¨¡å¼

```bash
# ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼ŒæŸ¥çœ‹è¯¦ç»†è¾“å‡º
python video_generator.py --run-once

# æ£€æŸ¥é…ç½®
python -c "import os; print('API_URL:', os.getenv('API_URL', 'http://localhost:3100/api/generate-video'))"
```

## åŸå§‹bashè„šæœ¬å¯¹æ¯”

| åŠŸèƒ½ | Bashè„šæœ¬ | Pythonç‰ˆæœ¬ |
|------|----------|------------|
| HTTPè¯·æ±‚ | `http` å‘½ä»¤ | `requests` åº“ |
| æ—¥æœŸå¤„ç† | `date` å‘½ä»¤ | `datetime` æ¨¡å— |
| å¾ªç¯å¤„ç† | bashæ•°ç»„å¾ªç¯ | Pythonåˆ—è¡¨å¾ªç¯ |
| æ–‡ä»¶åŒæ­¥ | `rsync` å‘½ä»¤ | `subprocess` è°ƒç”¨rsync |
| å®šæ—¶è°ƒåº¦ | å¤–éƒ¨cron | å†…ç½®scheduleåº“ |
| é”™è¯¯å¤„ç† | åŸºç¡€ | å®Œæ•´çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿— |
| å¯ç»´æŠ¤æ€§ | è¾ƒä½ | é«˜ |
| è°ƒè¯•èƒ½åŠ› | æœ‰é™ | å¼ºå¤§ |
| éƒ¨ç½²å¤æ‚åº¦ | ä¸­ç­‰ | ç®€å• |

## è®¸å¯è¯

MIT License